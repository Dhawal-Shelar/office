{% extends 'base.html' %}
{% load static %}
{% block title %}Payment - {{ selected_venue.name|default:"Venue" }}{% endblock %}

{% block extra_head %}
<style>
.card-hover:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
}
.btn-outline-orange {
    border-color: #ff7e5f;
    color: #ff7e5f;
}
.btn-outline-orange:hover {
    background-color: #ff7e5f;
    color: #fff;
}
.quantity-input {
    width: 60px;
    text-align: center;
}
.service-preview {
    width: 100%;
    max-height: 150px;
    object-fit: cover;
    margin-bottom: 10px;
}
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <h2>Hi {{ visitor.fname }}, confirm your requisition</h2>

    <div class="row g-4">
        <!-- LEFT: Extra items -->
        <div class="col-lg-8">
            <h4 class="mb-3">Selected Extra Requisitions</h4>
            <div class="row g-3">
                {% for item in extra_items %}
                <div class="col-md-6">
                    <div class="card shadow-sm card-hover p-3">
                        <h5>{{ item.name }}</h5>
                        {% if item.image %}
                        <img src="{{ item.image.url }}" alt="{{ item.name }}" class="service-preview" id="preview-{{ item.id }}">
                        {% else %}
                        <img src="{% static 'images/placeholder.jpg' %}" alt="Placeholder" class="service-preview">
                        {% endif %}
                        <p class="mb-1">Unit Price: ₹<span class="unit-price">{{ item.price|default:"0" }}</span></p>

                        {% if item.name in numeric_fields %}
                            <p class="mt-2">Selected Quantity: <span class="item-total">{{ item.selected_quantity|default:"0" }}</span></p>
                        {% endif %}

                        {% if item.selected_service %}
                            <p>Selected Service: <strong>{{ item.selected_service|title }}</strong></p>
                        {% endif %}
                    </div>
                </div>
                {% empty %}
                <p class="text-muted">No extra requisitions selected.</p>
                {% endfor %}
            </div>
        </div>

        <!-- RIGHT: Summary -->
        <div class="col-lg-4">
            <h4 class="mb-3">Summary</h4>
            <div class="card shadow-sm p-3 mb-3">
                <p>Event: <strong>{{ event.name }}</strong></p>
                <p>Venue: <span id="selectedVenue">{{ selected_venue.name|default:"None" }}</span></p>
                <p>Base Price: ₹<span id="baseAmount">{{ selected_venue.discounted_price|default:"0" }}</span></p>
                <hr>
                <p>Extras Total: ₹<span id="extraAmount">0.00</span></p>
                <p class="fw-bold">Total Estimated: ₹<span id="totalAmount">{{ selected_venue.discounted_price|default:"0" }}</span></p>

                {% if user.is_authenticated %}
                <!-- Authenticated users proceed to payment -->
                <form action="{% url 'events:payment_page' %}" method="POST" class="mt-3">
                    {% csrf_token %}
                    <input type="hidden" name="requisition_id" value="{{ requisition.id }}">
                    <button type="submit" class="btn btn-success w-100 btn-lg">Confirm & Proceed to Payment</button>
                </form>
                {% else %}
                <!-- Unauthenticated users go to login -->
                <a href="{% url 'account_login' %}?next={{ request.path }}" class="btn btn-warning w-100 btn-lg mt-3">
                    Login to Proceed
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const extraAmountEl = document.getElementById('extraAmount');
    const totalAmountEl = document.getElementById('totalAmount');
    const baseAmountEl = document.getElementById('baseAmount');

    function updateTotals() {
        let extraTotal = 0;
        document.querySelectorAll('.card-hover').forEach(card => {
            const qty = parseFloat(card.querySelector('.item-total')?.textContent) || 0;
            const unitPrice = parseFloat(card.querySelector('.unit-price')?.textContent) || 0;
            extraTotal += qty * unitPrice;
        });
        extraAmountEl.textContent = extraTotal.toFixed(2);
        const base = parseFloat(baseAmountEl.textContent) || 0;
        totalAmountEl.textContent = (base + extraTotal).toFixed(2);
    }

    updateTotals();
});
</script>
{% endblock %}
