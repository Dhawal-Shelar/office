{% extends 'base.html' %}
{% load static %}
{% block title %}Venues{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
.card-hover:hover { 
    transform: translateY(-5px); 
    box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
    transition: all 0.3s ease; 
}
.btn-outline-orange { border-color: #ff7e5f; color: #ff7e5f; }
.btn-outline-orange:hover { background-color: #ff7e5f; color: #fff; }
.text-decoration-line-through { text-decoration: line-through; }
#venueMap { height: 400px; width: 100%; }
.card-body { display: flex; flex-direction: column; }
.selected-venue { border: 2px solid #ff7e5f; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">

    <!-- Search Bar -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <form method="get" class="d-flex">
                <input type="text" name="q" class="form-control me-2" placeholder="Search by venue name, city, or area" value="{{ request.GET.q|default:'' }}">
                <button type="submit" class="btn btn-outline-orange">Search</button>
            </form>
        </div>
    </div>

    <div class="row g-4">
        <!-- LEFT: Venue Grid -->
        <div class="col-lg-8">
            <div class="row g-4">
                {% for venue in venues %}
                <div class="col-md-4">
                    <div class="card shadow-sm h-100 card-hover {% if requisition.selected_venue and requisition.selected_venue.id == venue.id %}selected-venue{% endif %}">
                        {% if venue.image %}
                        <img src="{{ venue.image.url }}" class="card-img-top" style="height:150px; object-fit:cover;">
                        {% else %}
                        <img src="{% static 'images/placeholder.jpg' %}" class="card-img-top" style="height:150px; object-fit:cover;">
                        {% endif %}
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">{{ venue.name }}</h5>
                            <p class="card-text">{{ venue.location }}{% if venue.area %}, {{ venue.area }}{% endif %}</p>
                            <p class="mb-1">
                                <span class="text-muted text-decoration-line-through">₹{{ venue.old_price|default:"0" }}</span>
                                <span class="fw-bold text-success ms-2">₹{{ venue.discounted_price|default:"0" }}</span>
                            </p>

                            <button class="btn btn-outline-orange w-100 mt-auto select-venue-btn"
                                data-venue-id="{{ venue.id }}"
                                data-requisition-id="{{ requisition.id }}"
                                data-lat="{{ venue.lat|default:'20.5937' }}"
                                data-lng="{{ venue.lng|default:'78.9629' }}">
                                Select Venue
                            </button>
                        </div>
                    </div>
                </div>
                {% empty %}
                <p class="text-muted">No venues found matching your search.</p>
                {% endfor %}
            </div>
        </div>

        <!-- RIGHT: Selected Venue + Map -->
        <div class="col-lg-4">
            <h4 class="mb-3">Selected Venue Details</h4>
            <div class="card shadow-sm p-3 mb-3" id="selectedVenueCard">
                <p class="mb-2">Venue: 
                    {% if requisition.selected_venue %}
                        {{ requisition.selected_venue.name }}
                    {% else %}
                        None
                    {% endif %}
                </p>
                <p class="mb-2">Base Price: ₹
                    {% if requisition.selected_venue %}
                        {{ requisition.selected_venue.discounted_price }}
                    {% else %}
                        0.00
                    {% endif %}
                </p>

                <!-- Always use <a> tag -->
                <a href="{% if requisition.selected_venue %}{% url 'events:extra_requisitions' requisition.id %}{% else %}#{% endif %}" 
                   class="btn {% if requisition.selected_venue %}btn-success{% else %}btn-secondary{% endif %} w-100 mt-3" 
                   id="gotoExtrasBtn" {% if not requisition.selected_venue %}aria-disabled="true"{% endif %}>
                   Go to Extra Requisitions
                </a>
            </div>

            <div class="card shadow-sm card-hover">
                <div class="card-header bg-gradient-orange text-white">
                    <h5 class="mb-0">Venue Location</h5>
                </div>
                <div class="card-body p-0">
                    <div id="venueMap"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const map = L.map('venueMap').setView([20.5937, 78.9629], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    let marker;
    function setMarker(lat, lng) {
        if(marker) map.removeLayer(marker);
        marker = L.marker([lat, lng]).addTo(map);
        map.setView([lat, lng], 12);
    }

    {% if requisition.selected_venue and requisition.selected_venue.lat and requisition.selected_venue.lng %}
        setMarker({{ requisition.selected_venue.lat }}, {{ requisition.selected_venue.lng }});
    {% else %}
        setMarker(20.5937, 78.9629);
    {% endif %}

    const selectedVenueCard = document.getElementById('selectedVenueCard');
    const gotoExtrasBtn = document.getElementById('gotoExtrasBtn');

    document.querySelectorAll('.select-venue-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const venueId = this.dataset.venueId;
            const requisitionId = this.dataset.requisitionId;
            const lat = parseFloat(this.dataset.lat);
            const lng = parseFloat(this.dataset.lng);

            document.querySelectorAll('.select-venue-btn').forEach(b => b.disabled = true);

            fetch("{% url 'events:save_selected_venue' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({venue_id: venueId, requisition_id: requisitionId})
            }).then(res => res.json())
            .then(data => {
                if(data.status === 'success'){
                    setMarker(lat, lng);

                    // Highlight selected card
                    document.querySelectorAll('.card').forEach(c => c.classList.remove('selected-venue'));
                    btn.closest('.card').classList.add('selected-venue');

                    // Update selected venue details
                    selectedVenueCard.querySelector('p:first-child').textContent = "Venue: " + data.venue_name;
                    selectedVenueCard.querySelector('p:nth-child(2)').textContent = "Base Price: ₹" + data.discounted_price;

                    // Enable "Go to Extra Requisitions" button dynamically
                    if(gotoExtrasBtn){
                        gotoExtrasBtn.href = "/events/extra_requisitions/" + requisitionId + "/";
                        gotoExtrasBtn.classList.remove('btn-secondary');
                        gotoExtrasBtn.classList.add('btn-success');
                        gotoExtrasBtn.removeAttribute('aria-disabled');
                    }
                } else {
                    alert('Error selecting venue: ' + data.message);
                }
            }).catch(err => {
                console.error(err);
                alert('Unexpected error occurred!');
            }).finally(() => {
                document.querySelectorAll('.select-venue-btn').forEach(b => b.disabled = false);
            });
        });
    });
});
</script>
{% endblock %}
