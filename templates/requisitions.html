{% extends "base.html" %}
{% load static %}
{% block title %}Payment – Travelsphere{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  .card-hover {
      transition: all 0.3s ease;
  }
  .card-hover:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0,0,0,0.2);
  }
  .payment-btn {
      background: linear-gradient(90deg, #ff7e5f, #feb47b);
      border: none;
      color: white;
      font-weight: bold;
      padding: 12px 25px;
      border-radius: 50px;
      transition: 0.3s;
  }
  .payment-btn:hover {
      transform: scale(1.05);
  }
  .info-label {
      font-weight: 600;
  }
  .total-cost {
      font-size: 1.2rem;
      font-weight: bold;
      color: #ff5722;
  }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">

  {% if requisition %}
    <div class="card card-hover shadow-sm">
      <div class="card-header bg-gradient-primary text-white">
        <h4 class="mb-0">Requisition #{{ requisition.id }} — {{ requisition.event.name }}</h4>
        <small>Created: {{ requisition.created_at|date:"Y-m-d H:i" }}</small>
      </div>
      <div class="card-body">

        <h5 class="mb-3">Visitor Information</h5>
        <div class="row mb-3">
          <div class="col-md-6">
            <p><span class="info-label">Name:</span> {{ requisition.visitor_name }}</p>
            <p><span class="info-label">Phone:</span> {{ requisition.phone }}</p>
            <p><span class="info-label">Email:</span> {{ requisition.email }}</p>
            <p><span class="info-label">Number of People:</span> {{ requisition.number_of_people }}</p>
          </div>
          <div class="col-md-6">
            <p><span class="info-label">Budget:</span> ₹{{ requisition.budget }}</p>
            <p><span class="info-label">Venue Type:</span> {{ requisition.venue_type }}</p>
            <p><span class="info-label">Religious Affiliation:</span> {{ requisition.religious_affiliation }}</p>
            <p><span class="info-label">Special Requests:</span> {{ requisition.special_requests|default:"None" }}</p>
          </div>
        </div>

        {% if requisition.extra_requisitions %}
          <h5 class="mb-3">Extra Requisitions</h5>
          <div class="row mb-3">
            <div class="col-md-6">
              <p><span class="info-label">Tables:</span> {{ requisition.extra_requisitions.tables }} (₹{{ requisition.extra_requisitions.tables_price }} each)</p>
              <p><span class="info-label">Chairs:</span> {{ requisition.extra_requisitions.chairs }} (₹{{ requisition.extra_requisitions.chairs_price }} each)</p>
              <p><span class="info-label">Balloons:</span> {{ requisition.extra_requisitions.baloons }} (₹{{ requisition.extra_requisitions.baloons_price }} each)</p>
              <p><span class="info-label">Garlands:</span> {{ requisition.extra_requisitions.garlands }} (₹{{ requisition.extra_requisitions.garlands_price }} each)</p>
            </div>
            <div class="col-md-6">
              <p><span class="info-label">Decor:</span> {{ requisition.extra_requisitions.decor }} (₹{{ requisition.extra_requisitions.decor_price }})</p>
              <p><span class="info-label">Band:</span> {{ requisition.extra_requisitions.band }} (₹{{ requisition.extra_requisitions.band_price }})</p>
              <p><span class="info-label">DJ:</span> {{ requisition.extra_requisitions.DJ }} (₹{{ requisition.extra_requisitions.DJ_price }})</p>
              <p><span class="info-label">Stereo:</span> {% if requisition.extra_requisitions.stereo %}Yes (₹{{ requisition.extra_requisitions.stereo_price }}){% else %}No{% endif %}</p>
              <p><span class="info-label">Lighting:</span> {% if requisition.extra_requisitions.lighting %}Yes (₹{{ requisition.extra_requisitions.lighting_price }}){% else %}No{% endif %}</p>
              <p><span class="info-label">Photography:</span> {% if requisition.extra_requisitions.photography %}Yes (₹{{ requisition.extra_requisitions.photography_price }}){% else %}No{% endif %}</p>
              <p><span class="info-label">Videography:</span> {% if requisition.extra_requisitions.videography %}Yes (₹{{ requisition.extra_requisitions.videography_price }}){% else %}No{% endif %}</p>
              <p><span class="info-label">Mic:</span> {% if requisition.extra_requisitions.mic %}Yes (₹20){% else %}No{% endif %}</p>
            </div>
          </div>

          <h5 class="total-cost mb-3">Total Extra Cost: ₹{{ requisition.extra_requisitions.total_cost }}</h5>
        {% endif %}

        <!-- Proceed to Payment Button -->
        <div class="text-center mt-4">
          <button id="pay-button" class="payment-btn"><i class="fas fa-credit-card"></i> Proceed to Payment</button>
        </div>

      </div>
    </div>

    <!-- Razorpay script -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
      const payButton = document.getElementById("pay-button");
      payButton.addEventListener("click", function () {
        fetch("{% url 'create_payment' requisition.id %}")
        .then(res => res.json())
        .then(data => {
          var options = {
              "key": data.key, // Razorpay key from backend
              "amount": data.amount, // in paise
              "currency": "INR",
              "name": "{{ requisition.visitor_name }}",
              "description": "Event Payment for {{ requisition.event.name }}",
              "order_id": data.order_id,
              "handler": function (response){
                  alert("Payment Successful! Payment ID: " + response.razorpay_payment_id);
                  window.location.href = "{% url 'payment_success' requisition.id %}";
              },
              "theme": {
                  "color": "#ff7e5f"
              }
          };
          var rzp1 = new Razorpay(options);
          rzp1.open();
        });
      });
    </script>

  {% else %}
    <p class="text-muted">No requisition available for payment.</p>
  {% endif %}

</div>
{% endblock %}
